name: Nightly Tests

on:
  schedule:
    # Every day at 3:00 AM UTC
    - cron: '0 3 * * *'
  workflow_dispatch: # Allow manual trigger

concurrency:
  group: nightly-tests
  cancel-in-progress: true

env:
  SCHEME: "Andernet Posture"
  PROJECT: "Andernet Posture.xcodeproj"
  DESTINATION: "platform=iOS Simulator,name=iPhone 16 Pro,OS=latest"
  XCODE_PATH: /Applications/Xcode_26.2.app/Contents/Developer

jobs:
  # ─── Full suite with sanitizers ───
  full-suite-sanitizers:
    name: Full Suite + Sanitizers
    runs-on: macos-15

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Select Xcode
        run: sudo xcode-select -s "$XCODE_PATH"

      - name: Cache SPM packages
        uses: actions/cache@v4
        with:
          path: |
            ~/Library/Developer/Xcode/DerivedData/**/SourcePackages
          key: ${{ runner.os }}-spm-${{ hashFiles('**/*.xcodeproj/project.pbxproj') }}
          restore-keys: |
            ${{ runner.os }}-spm-

      - name: Resolve dependencies
        run: xcodebuild -resolvePackageDependencies -project "$PROJECT" -scheme "$SCHEME"

      - name: Build for testing (with Thread Sanitizer)
        run: |
          xcodebuild build-for-testing \
            -project "$PROJECT" \
            -scheme "$SCHEME" \
            -destination "$DESTINATION" \
            -skipPackagePluginValidation \
            -enableThreadSanitizer YES \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            | xcpretty --color && exit ${PIPESTATUS[0]}

      - name: Run full test suite (unit tests with TSan)
        run: |
          xcodebuild test-without-building \
            -project "$PROJECT" \
            -scheme "$SCHEME" \
            -destination "$DESTINATION" \
            -only-testing "Andernet PostureTests" \
            -enableThreadSanitizer YES \
            -enableCodeCoverage YES \
            -resultBundlePath NightlyUnitResults.xcresult \
            | xcpretty --color && exit ${PIPESTATUS[0]}

      - name: Upload unit test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: NightlyUnitResults
          path: NightlyUnitResults.xcresult

  # ─── Full UI test suite ───
  full-ui-tests:
    name: Full UI Tests
    runs-on: macos-15

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Select Xcode
        run: sudo xcode-select -s "$XCODE_PATH"

      - name: Cache SPM packages
        uses: actions/cache@v4
        with:
          path: |
            ~/Library/Developer/Xcode/DerivedData/**/SourcePackages
          key: ${{ runner.os }}-spm-${{ hashFiles('**/*.xcodeproj/project.pbxproj') }}
          restore-keys: |
            ${{ runner.os }}-spm-

      - name: Resolve dependencies
        run: xcodebuild -resolvePackageDependencies -project "$PROJECT" -scheme "$SCHEME"

      - name: Build for testing
        run: |
          xcodebuild build-for-testing \
            -project "$PROJECT" \
            -scheme "$SCHEME" \
            -destination "$DESTINATION" \
            -skipPackagePluginValidation \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            | xcpretty --color && exit ${PIPESTATUS[0]}

      - name: Run full UI test suite
        run: |
          xcodebuild test-without-building \
            -project "$PROJECT" \
            -scheme "$SCHEME" \
            -destination "$DESTINATION" \
            -testPlan FullSuite \
            -enableCodeCoverage YES \
            -resultBundlePath NightlyFullSuiteResults.xcresult \
            | xcpretty --color && exit ${PIPESTATUS[0]}

      - name: Upload full suite results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: NightlyFullSuiteResults
          path: NightlyFullSuiteResults.xcresult

  # ─── Accessibility tests ───
  accessibility-tests:
    name: Accessibility Tests
    runs-on: macos-15

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Select Xcode
        run: sudo xcode-select -s "$XCODE_PATH"

      - name: Cache SPM packages
        uses: actions/cache@v4
        with:
          path: |
            ~/Library/Developer/Xcode/DerivedData/**/SourcePackages
          key: ${{ runner.os }}-spm-${{ hashFiles('**/*.xcodeproj/project.pbxproj') }}
          restore-keys: |
            ${{ runner.os }}-spm-

      - name: Resolve dependencies
        run: xcodebuild -resolvePackageDependencies -project "$PROJECT" -scheme "$SCHEME"

      - name: Build for testing
        run: |
          xcodebuild build-for-testing \
            -project "$PROJECT" \
            -scheme "$SCHEME" \
            -destination "$DESTINATION" \
            -skipPackagePluginValidation \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            | xcpretty --color && exit ${PIPESTATUS[0]}

      - name: Run accessibility tests
        run: |
          xcodebuild test-without-building \
            -project "$PROJECT" \
            -scheme "$SCHEME" \
            -destination "$DESTINATION" \
            -testPlan AccessibilityTests \
            -resultBundlePath NightlyA11yResults.xcresult \
            | xcpretty --color && exit ${PIPESTATUS[0]}

      - name: Upload accessibility test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: NightlyA11yResults
          path: NightlyA11yResults.xcresult
