#!/bin/bash
# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
# Git pre-commit hook for Andernet Posture
# Install: cp .vscode/scripts/pre-commit .git/hooks/pre-commit && chmod +x .git/hooks/pre-commit
# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
set -euo pipefail

echo "üîç Pre-commit: checking staged Swift files..."

# Get staged .swift files
STAGED_SWIFT=$(git diff --cached --name-only --diff-filter=ACM -- '*.swift')

if [ -z "$STAGED_SWIFT" ]; then
    echo "  No staged Swift files ‚Äî skipping checks."
    exit 0
fi

ERRORS=0

# ‚îÄ‚îÄ 1. SwiftLint on staged files ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
if command -v swiftlint &>/dev/null; then
    echo "  Running SwiftLint..."
    echo "$STAGED_SWIFT" | while IFS= read -r file; do
        if [ -f "$file" ]; then
            swiftlint lint --config .swiftlint.yml --path "$file" --quiet 2>/dev/null || true
        fi
    done
    # Check for errors (not warnings)
    LINT_ERRORS=0
    while IFS= read -r file; do
        if [ -f "$file" ]; then
            if swiftlint lint --config .swiftlint.yml --path "$file" --quiet 2>/dev/null | grep -q ": error:"; then
                LINT_ERRORS=1
            fi
        fi
    done <<< "$STAGED_SWIFT"

    if [ "$LINT_ERRORS" -eq 1 ]; then
        echo "  ‚ùå SwiftLint errors found. Fix them or commit with --no-verify."
        ERRORS=1
    else
        echo "  ‚úÖ SwiftLint passed"
    fi
else
    echo "  ‚è≠Ô∏è  SwiftLint not installed ‚Äî skipping"
fi

# ‚îÄ‚îÄ 2. Check for common issues ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
echo "  Checking for debug artifacts..."
while IFS= read -r file; do
    if [ -f "$file" ]; then
        # Check for leftover debug prints
        if grep -nE '^\s*(print\(|debugPrint\(|dump\()' "$file" | head -3; then
            echo "  ‚ö†Ô∏è  $file: contains print/debugPrint/dump statements"
        fi
        # Check for TODO/FIXME/HACK
        if grep -nE '(TODO|FIXME|HACK|XXX):' "$file" | head -3; then
            echo "  ‚ÑπÔ∏è  $file: contains TODO/FIXME markers (not blocking)"
        fi
    fi
done <<< "$STAGED_SWIFT"

# ‚îÄ‚îÄ 3. Verify build compiles (optional, toggle with env var) ‚îÄ
if [ "${AP_PRECOMMIT_BUILD:-0}" = "1" ]; then
    echo "  Building project..."
    if ! xcodebuild -scheme "Andernet Posture" -project "Andernet Posture.xcodeproj" \
        -destination "platform=iOS Simulator,name=iPhone 17 Pro" \
        -derivedDataPath .build/DerivedData build 2>&1 | xcbeautify --quieter; then
        echo "  ‚ùå Build failed"
        ERRORS=1
    else
        echo "  ‚úÖ Build passed"
    fi
fi

if [ "$ERRORS" -ne 0 ]; then
    echo ""
    echo "‚ùå Pre-commit checks failed. Fix issues or use: git commit --no-verify"
    exit 1
fi

echo "‚úÖ Pre-commit checks passed"
